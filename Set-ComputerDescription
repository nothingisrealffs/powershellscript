function Set-ComputerDescription {
<#
.SYNOPSIS
Sets AD computer description with validated department, name, model, and location.
.PARAMETER Department
Department code (e.g., "d1" or "new:d6" to add new)
.PARAMETER Name
Person's name (e.g., "John Doe")
.PARAMETER CompModel
Computer model (e.g., "Dell Latitude" or "new:Asus 4521" to add new)
.PARAMETER Location
Location code with optional room (e.g., "uc" or "uc 3005" or "new:tr")
.PARAMETER Testing
If enabled, uses Search-MemList to get PC. Otherwise uses Get-APC.    
.EXAMPLE
Set-ComputerDescription -Department "d1" -Name "John Doe" -CompModel "Dell Latitude" -Location "uc 3005" 
.EXAMPLE
Set-ComputerDescription -Department "new:d6" -Name "Jane Smith" -CompModel "new:Asus 4521" -Location "bs" -Testing
#>
    [CmdletBinding()]
    param (
        [Parameter(Mandatory=$true)]
        [string]$Department,
        [Parameter(Mandatory=$true)]
        [string]$Name,
        [Parameter(Mandatory=$true)]
        [string]$CompModel,
        [Parameter(Mandatory=$true)]
        [string]$Location,
        [switch]$Testing
    )
    # Ensure global arrays exist (should be in $PROFILE)
    if (-not $global:ac_dept) {
        throw "Global array `$global:ac_dept not found. Please define it in your `$PROFILE."
    }
    if (-not $global:ac_models) {
        throw "Global array `$global:ac_models not found. Please define it in your `$PROFILE."
    }
    if (-not $global:ac_location) {
        throw "Global array `$global:ac_location not found. Please define it in your `$PROFILE."
    }
    $deptTokens = $Department.Trim() -split ':'
    if ($deptTokens.Count -gt 1) {
        # Handle "new:d6" or "new:IEL" syntax
        if ($deptTokens[0].ToLower() -eq 'new') {
            $newDept = $deptTokens[1].Trim().ToLower()
            if ($global:ac_dept -contains $newDept) {
                Write-Host "Department '$newDept' already exists." -ForegroundColor Yellow
                $validatedDept = $newDept
            } else {
                $global:ac_dept += $newDept
                Add-Content $PROFILE "`n`$global:ac_dept += '$newDept'"
                Write-Host "Added new department: $newDept" -ForegroundColor Green
                $validatedDept = $newDept
            }
        } else {
            throw "Invalid department syntax. Use 'new:code' to add a new department."
        }
    } else {
        $deptLower = $deptTokens[0].ToLower()
        if ($global:ac_dept -contains $deptLower) {
            $validatedDept = $deptLower
            Write-Host "Valid department: $validatedDept" -ForegroundColor Cyan
        } else {
            throw "Unknown department '$deptLower'. Use 'new:$deptLower' to add it."
        }
    }
    $nameTokens = $Name.Trim() -split '\s+'
    if ($nameTokens.Count -lt 2) {
        $validatedName = $nameTokens[0]
        Write-Host "Single name provided: $validatedName" -ForegroundColor Yellow
    } else {
        $LastName = $nameTokens[-1]
        $FirstName = $nameTokens[0..($nameTokens.Count - 2)] -join ' '
        $validatedName = "$LastName, $FirstName"
        Write-Host "Formatted name: $validatedName" -ForegroundColor Cyan
    }
    # Special case: Dell PB14250 is always valid
    if ($CompModel -ieq 'Dell PB14250') {
        $validatedModel = 'Dell PB14250'
        Write-Host "Special model: $validatedModel" -ForegroundColor Cyan
    } else {
        $tokens = ($CompModel.Trim() -split '\s+') | ForEach-Object { $_.ToLower() }
        if ($tokens[0] -match '^new:(.+)$') {
            # Handle "new:Brand Model" syntax
            $candidateRaw = $Matches[1].Trim()
            if (-not $candidateRaw) {
                throw "Bad 'new:' syntax. Supply a model/brand after colon (e.g., 'new:Asus')."
            }
            $candidate = $candidateRaw.ToLower()
            $modelPart = if ($tokens.Count -gt 1) {
                ($tokens[1..($tokens.Count - 1)] -join ' ')
            } else { '' }
            if ($global:ac_models -contains $candidate) {
                $validatedModel = ("$candidateRaw $modelPart").Trim()
                Write-Host "Model already exists: $validatedModel" -ForegroundColor Yellow
            } else {
                $global:ac_models += $candidate
                Add-Content $PROFILE "`n`$global:ac_models += '$candidate'"
                $validatedModel = ("$candidateRaw $modelPart").Trim()
                Write-Host "Added new model: $validatedModel" -ForegroundColor Green
            }
        } else {
            # Regular lookup
            $brandOrModel = $tokens[0]
            $modelPart = if ($tokens.Count -gt 1) {
                ($tokens[1..($tokens.Count - 1)] -join ' ')
            } else { '' }
            if ($global:ac_models -contains $brandOrModel) {
                $validatedModel = ("$brandOrModel $modelPart").Trim()
                Write-Host "Valid model: $validatedModel" -ForegroundColor Cyan
            } else {
                throw "Unknown model/brand '$brandOrModel'. Use 'new:Brand Model' to add it."
            }
        }
    }
    $locInput = $Location.Trim()
    # Check if it starts with "new:"
    if ($locInput -match '^new:(.+)$') {
        $newLocFull = $Matches[1].Trim()
        # Extract just the location code (first word/token)
        $newLocCode = ($newLocFull -split '\s+')[0].ToLower()
        
        if ($newLocCode.Length -gt 20) {
            throw "Location codes should be reasonably short (max 20 characters)."
        }
        if ($global:ac_location -contains $newLocCode) {
            Write-Host "Location code '$newLocCode' already exists." -ForegroundColor Yellow
        } else {
            $global:ac_location += $newLocCode
            Add-Content $PROFILE "`n`$global:ac_location += '$newLocCode'"
            Write-Host "Added new location code: $newLocCode" -ForegroundColor Green
        }
        $validatedLocation = $newLocFull.ToLower()
    } else {
        # Extract location code (first word) and any room number
        $locTokens = $locInput -split '\s+', 2
        $locCode = $locTokens[0].ToLower()
        $roomNumber = if ($locTokens.Count -gt 1) { $locTokens[1] } else { '' }
        # Check if the location code exists
        if ($global:ac_location -contains $locCode) {
            # Build the full location with room number if provided
            if ($roomNumber) {
                $validatedLocation = "$locCode $roomNumber"
            } else {
                $validatedLocation = $locCode
            }
            Write-Host "Valid location: $validatedLocation" -ForegroundColor Cyan
        } else {
            throw "Unknown location code '$locCode'. Use 'new:$locCode' to add it, or check if it's in the global array."
        }
    }
    $megastring = "$validatedDept $validatedName $validatedModel $validatedLocation"
    Write-Host "`nFinal Description: $megastring" -ForegroundColor Green
    try {
        if ($Testing) {
            Write-Host "`n[Testing Mode] Using Search-MemList..." -ForegroundColor Magenta
            $computer = Search-MemList
            if (-not $computer) {
                throw "Search-MemList returned no computer."
            }
        } else {
            Write-Host "`nUsing Get-APC..." -ForegroundColor Magenta
            $computer = Get-APC
            if (-not $computer) {
                throw "Get-APC returned no computer."
            }
        }
        Write-Host "Setting description on computer: $($computer.Name)" -ForegroundColor Cyan
        Set-ADComputer -Identity $computer.Name -Description $megastring
        Write-Host "Description updated successfully!" -ForegroundColor Green
        
    } catch {
        Write-Error "Failed to set computer description: $_"
    }
}
